<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Tutorial HTK: Reconocedor de Dígitos en español.  : HTK, Dígitos, Español" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Tutorial HTK: Reconocedor de Dígitos en español. </title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/pbrusco">View on GitHub</a>

          <h1 id="project_title">Tutorial HTK: Reconocedor de Dígitos en español. </h1>
          <h2 id="project_tagline">HTK, Dígitos, Español</h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h2>Tarea</h2>

<p>A continuación implementaremos un reconocedor de dígitos en español, para ello utilizaremos HTK (una implementación de <a href="http://es.wikipedia.org/wiki/Modelo_oculto_de_M%C3%A1rkov">Modelos Ocultos de Markov</a> y seguiremos los pasos recomendados en el <a href="http://htk.eng.cam.ac.uk/docs/docs.shtml">manual de HTK</a>.</p>

<p>Pueden ver el código completo en este <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/e393a5db8f242bb9b173f570fdd06554be5aa968/HTK/spike%20digitos?at=master">repositorio.</a></p>

<h3>Hacia dónde vamos?</h3>

<p>La idea de este tutorial es lograr, a partir de grabaciones de audio que contienen dígitos (solo dígitos),  obtener la transcripción de </p>

<p><strong>Entrada</strong>
 <img src="https://dl.dropboxusercontent.com/u/43547597/Tutorial%20HTK/12151516790.png" alt="12151516790"></p>

<p><strong>Salida</strong>
"1 2 1 5 1 5 1 6 7 9 0"</p>

<h2>Preámbulos</h2>

<p>La tarea de reconocimiento del habla (speech recognition) se basa en .. </p>

<p>Teoría...</p>

<p>Software ...</p>

<h2>Preparando el entorno</h2>

<p>Para poder generar nuestro reconocedor, primero debemos instalar <a href="http://htk.eng.cam.ac.uk/download.shtml">The Hidden Markov Model Toolkit (HTK)</a>. La forma de instalarlo depende de nuestro sistema operativo:</p>

<h3>HTK en Ubuntu</h3>

<p>Dentro de la carpeta descargada: </p>

<pre><code> ./configure
make all
sudo make install
</code></pre>

<p>Solución posible de algunos problemas probables:</p>

<pre><code>sudo apt-get install gcc-multilib
sudo apt-get install libx11-dev
./configure --disable-hslab (por un error -lX11) 
</code></pre>

<p>(si fue necesario realizar el ultimo paso, no dispondremos de la herramienta HSLab, reemplazable por, por ejemplo, audacity)</p>

<h3>HTK en MAC (Mountain Lion)</h3>

<p>Instalar XQuartz</p>

<p>Instalar HTK usando los consejos que se dan en la esta <a href="http://aidiary.hatenablog.com/entry/20130113/1358046622">página</a>, traducir usando el traductor de google por ejemplo y tener cuidado que los comandos también se traducen (próximamente agregaré los comandos en esta guía)</p>

<p>Básicamente, indica que hay que agregar -I/usr/X11R6/include en los cflags de los makefiles que estan, en el directorio de htk y en htklib.</p>

<h3>Otros</h3>

<p>Además de HTK, recomiendo tener instalado <a href="http://www.ruby-lang.org/es/downloads/">Ruby</a> (para ciertos scripts .rb) </p>

<h3>Organización del código</h3>

<p>Para lograr hacer funcionar el programa, deberemos fijar la ubicación de cada uno de los archivos que creemos, recomiendo utilizar la misma estructura que yo utilizo ya que los comandos están preparados para estas rutas. Por supuesto, al ir entendiendo cada uno de los comandos y scripts, los archivos podrán ser movidos a donde el que los utilice considere.</p>

<p><a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/dff4b6c3e0a6/HTK/spike%20digitos/code_organization.txt?at=master">Aquí</a> podrán encontrar una posible organización y es en la cual me basaré a partir de ahora. La idea no es intentar entenderla desde un principio, sino consultarla cuando se tiene alguna duda. </p>

<h3>Sobre el formato de los archivos</h3>

<p>Una aclaración que puede ahorrarles horas de errores incomprensibles. En <strong>TODOS</strong> los archivos que se utilicen en los comandos de HTK, chequeen que siempre haya un "enter" al final (y que se encuentre en formato unix, opción disponible si usan <a href="http://www.sublimetext.com/">Sublime</a>: View/Line Endings/Unix por ejemplo)</p>

<h2>Primer Parte: Preparando los datos</h2>

<h3>Paso 1: Gramática</h3>

<p>Para que nuestro programa entienda palabras, lo primero que debemos indicarle es que forma pueden tener las oraciones que grabemos.</p>

<p>Dado que en nuestro caso queremos reconocer dígitos, lo haremos con la siguiente grámatica:</p>

<pre><code>$digito = UNO | DOS | TRES | CUATRO | CINCO | SEIS | SIETE | OCHO | NUEVE | CERO;
( SENT-START ( &lt;$digito&gt; ) SENT-END )
</code></pre>

<p>Nombre del archivo: <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/master/HTK/spike%20digitos/Dictionary/DictionarySources/grammar?at=master">Dictionary/DictionarySources/grammar</a></p>

<p>Más info sobre el <a href="http://www.ee.columbia.edu/ln/LabROSA/doc/HTKBook21/node131.html">lenguaje utilizado</a></p>

<p>Básicamente, se indica a través de este archivo, que las grabaciones tendrán dígitos (uno o más). </p>

<h3>Paso 2: Listado de palabras</h3>

<p>En este paso debemos listar todas las posibles palabras de nuestra gramática (ordenadas alfabeticamente). Para ello, podemos listarlas y luego aplicar el comando "sort" de unix. </p>

<pre><code>CERO
CINCO
CUATRO
DOS
NUEVE
OCHO
SEIS
SENT-END
SENT-START
SIETE
TRES
UNO
</code></pre>

<p>Nombre del archivo: <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/master/HTK/spike%20digitos/Dictionary/DictionarySources/words-sorted.list?at=master">Dictionary/DictionarySources/words-sorted.list</a></p>

<h3>Paso 3: Diccionario de fonemas</h3>

<pre><code>CERO s e r o sp
CINCO s i n c o sp
CUATRO k u a t r o sp
DOS d o s sp
NUEVE n u e b e sp
OCHO o ch o sp
SEIS s e i s sp
SENT-END sil
SENT-START sil
SIETE s i e t e sp
TRES t r e s sp
UNO u n o sp
</code></pre>

<p>Nombre del archivo: <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/master/HTK/spike%20digitos/Dictionary/DictionarySources/dict?at=master">Dictionary/DictionarySources/dict</a></p>

<h3>Paso 4: Grabando datos de entrenamiento</h3>

<p>Para poder entrenar nuestro sistema, se necesitan grabaciones de entrenamiento, la decisión sobre que datos de entrenamiento usar implican un mejor o peor desempeño en el reconocedor. Para esta prueba en particular, se grabaron 4 sets de entrenamiento (train1, train2, train3 y train4) en dónde cada uno contiene una grabación por cada dígito (de manera aislada, es decir, solo el dígito de comienzo a fin sin silencios) </p>

<p>Ejemplo: <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/master/HTK/spike%20digitos/Data/Recorded/waves/train/train1/6.wav?at=master">Data/Recorded/waves/train/train1/6.wav</a></p>

<p>Por otro lado, cada uno de estos datos de entrenamiento necesitan una transcripción (.lab), esta transcripción debe contener los fonemas que se utilizan en la palabra grabada. </p>

<p>En vez de hacerlo manualmente, aprovecharemos un script que se encargará de facilitarnos ese trabajo, pero en caso de no tener este script, habría que construirlos manualmente con la pinta:</p>

<pre><code>0.0 0.5064375  o ch o
</code></pre>

<p>Nombre del archivo: <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/master/HTK/spike%20digitos/Data/Train/train1-8.lab?at=master">Data/Train/train1-8.lab</a></p>

<p>El script que utilizaremos es <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/master/HTK/spike%20digitos/Helpers/labels_from_wavs_script.rb?at=master">Helpers/labels_from_wavs_script.rb</a></p>

<pre><code>irb Helpers/labels_from_wavs_script.rb "Data/Recorded/waves/train/" "Data/Train/"
</code></pre>

<p>Este scipt escanea Data/Recorded/waves/train en búsqueda de subcarpetas que contengan wavs. Al encontrarlos, genera un archivo .lab por cada .wav y los guarda en el la carpeta del segundo parametro "Data/Train/" con el nombre -.lab (ejemplo el archivo train1-8.lab mostrado anteriormente)</p>

<h2>Segunda Parte: Combinando los datos</h2>

<h3>Diccionario y listado de fonemas</h3>

<p>Para generar el diccionario y listado de fonemas que utilizaremos más adelante, usaremos el comando HDMan de HTK: </p>

<pre><code>HDMan -m -w Dictionary/DictionarySources/words-sorted.list -n Dictionary/phones-with-sp.list -l dlog Dictionary/phones.dict Dictionary/DictionarySources/dict
</code></pre>

<p>Esto último, genera 2 archivos importantes: <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/master/HTK/spike%20digitos/Dictionary/phones.dict?at=master">Dictionary/phones.dict</a> y <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/master/HTK/spike%20digitos/Dictionary/phones-with-sp.list?at=master">Dictionary/phones-with-sp.list</a>, y por otro lado, un log (dlog) que sirve para ver cuantas repeticiones de los fonemas se utilizan. </p>

<p>Podrán notar que phones.dict y DictionarySources/dict son muy parecidos (o iguales en este caso), la razón para que esto ocurra es que dict es usado como source para generar phones.dict, y solo se toma de él las palabras que aparecen en word-sorted.list. Es decir, sería totalmente posible tener un diccionario dict con muchas más traducciones palabra-fonemas como source. </p>

<p>Luego, debemos crear un nuevo archivo copiando Dictionary/phones-with-sp.list en el cual borremos la linea que contiene al fonema "sp", generando así el archivo <a href="https://bitbucket.org/pbrusco/tesis-proyectos/src/master/HTK/spike%20digitos/Dictionary/phones.list?at=master">Dictionary/phones.list</a></p>

<h3>Gramática a WordNet</h3>

<p>HTK utiliza un formato especial para representar la gramática, es un "word network" (red de palabras), básicamente, es una notación de bajo nivel llamada "HTK Standard Lattice Format (SLF)" en el cual, cada instancia de palabra y cada transición entre palabras esta listado explicitamente. Podemos crear esta red automaticamente utilizando el comando</p>

<pre><code>HParse Dictionary/DictionarySources/grammar Dictionary/DictionarySources/grammar.wordnet 
</code></pre>

<h3>Master label files (mlf)</h3>

<p>Create "MFCCs words.mlf"</p>

<pre><code>irb Helpers/generate_mfccs_from_training.rb
</code></pre>

<p>(then, modify each element to contain a word transcription of what each file says)</p>

<p>Transcribe words.mlf into phones.mlf (for training data in this case):</p>

<pre><code>HLEd -l ’*’ -d Dictionary/phones.dict -i Data/train\ MFCCs-phones.mlf Configs/HLEd.config Data/train\ MFCCs-words.mlf
</code></pre>

<h3>Listado de archivos de entrenamiento para HCopy</h3>

<p>Generate HCopy.script </p>

<pre><code>irb Helpers/generate_hcopy_script.rb
</code></pre>

<h3>Mel Frequency Cepstral Coefficients</h3>

<p>Generate MFCCs from wavs:</p>

<pre><code>HCopy -T 1 -C Configs/HCopy.config -S Scripts/HCopy.script
</code></pre>

<h3>Preparando la estructura para el modelo</h3>

<p>Create directories for models:</p>

<pre><code>for NUMBER in {0..9}
do
  mkdir Models/hmm$NUMBER
done
</code></pre>

<h3>Listado de archivos de entrenamiento para HCompV</h3>

<p>Generate HCompV.script file:</p>

<pre><code>irb Helpers/generate_hcompv_script.rb
</code></pre>

<h2>Tercer Parte: Entrenamiento del modelo</h2>

<h3>Hmm0 - Hmm3</h3>

<p>Train first prototype model into hmm0 folder:</p>

<pre><code>HCompV -C Configs/HCompV.config -f 0.01 -m -S Scripts/HCompV.script -M Models/hmm0 Models/prototype
</code></pre>

<p>--copy prototype to hmmdefs (to each phoneme) --
--copy vFloors to macros -- </p>

<p>Generate HERest.script file:</p>

<pre><code>irb Helpers/generate_herest_script.rb
</code></pre>

<p>Re-estimate using embedded re-estimation tool HERest:</p>

<pre><code>HERest -T 1 -C Configs/HERest.config -I Data/train\ MFCCs-phones.mlf -t 1000.0 1000.0 10000.0 -S Scripts/HERest.script -H Models/hmm0/macros -H Models/hmm0/hmmdefs -M Models/hmm1 Dictionary/phones.list
HERest -T 1 -C Configs/HERest.config -I Data/train\ MFCCs-phones.mlf -t 1000.0 1000.0 10000.0 -S Scripts/HERest.script -H Models/hmm1/macros -H Models/hmm1/hmmdefs -M Models/hmm2 Dictionary/phones.list
HERest -T 1 -C Configs/HERest.config -I Data/train\ MFCCs-phones.mlf -t 1000.0 1000.0 10000.0 -S Scripts/HERest.script -H Models/hmm2/macros -H Models/hmm2/hmmdefs -M Models/hmm3 Dictionary/phones.list
</code></pre>

<h3>Hmm4 - Hmm7</h3>

<p>(After adding the new "sp" state after copying from hmm3 to hmm4 and adding sp using center state of sil) (<a href="http://www.voxforge.org/home/dev/acousticmodels/linux/create/htkjulius/tutorial/monophones/step-7">http://www.voxforge.org/home/dev/acousticmodels/linux/create/htkjulius/tutorial/monophones/step-7</a>)</p>

<pre><code>HHEd -A -D -T 1 -H Models/hmm4/macros -H Models/hmm4/hmmdefs -M Models/hmm5 Configs/HHEd.config Dictionary/phones-with-sp.list
</code></pre>

<pre><code>HERest -T 1 -C Configs/HERest.config -I Data/train\ MFCCs-phones.mlf -t 1000.0 1000.0 10000.0 -S Scripts/HERest.script -H Models/hmm5/macros -H Models/hmm5/hmmdefs -M Models/hmm6 Dictionary/phones-with-sp.list
HERest -T 1 -C Configs/HERest.config -I Data/train\ MFCCs-phones.mlf -t 1000.0 1000.0 10000.0 -S Scripts/HERest.script -H Models/hmm6/macros -H Models/hmm6/hmmdefs -M Models/hmm7 Dictionary/phones-with-sp.list
</code></pre>

<h2>Cuarta Parte: A Probar Resultados</h2>

<h3>Grabar datos para testear</h3>

<h3>Generar vectores MFCC</h3>

<p>Test models: 
Generate tests MFCCs:</p>

<pre><code>HCopy -T 1 -C Configs/HCopyTests.config -S Scripts/HCopyTests.script
</code></pre>

<h3>Obtener resultados</h3>

<p>Results:</p>

<pre><code>HVite -H Models/hmm7/macros -H Models/hmm7/hmmdefs -S Scripts/HVite.script -l ’*’ -i recout.mlf -w Dictionary/DictionarySources/grammar.wordnet -p 0.0 -s 5.0 Dictionary/phones.dict Dictionary/phones-with-sp.list
</code></pre>

<h3>Obtener resultados en vivo</h3>

<p>Live Results:
HVite -H Models/hmm7/macros -H Models/hmm7/hmmdefs -C Configs/Live.config -w Dictionary/DictionarySources/grammar.wordnet -p 0.0 -s 5.0 Dictionary/phones.dict Dictionary/phones-with-sp.list</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
